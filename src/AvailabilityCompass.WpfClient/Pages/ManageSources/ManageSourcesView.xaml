<UserControl x:Class="AvailabilityCompass.WpfClient.Pages.ManageSourcesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:manageSources="clr-namespace:AvailabilityCompass.Core.Features.ManageSources;assembly=AvailabilityCompass.Core"
             xmlns:converters="clr-namespace:AvailabilityCompass.WpfClient.Pages.ManageSources.Converters"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             d:DataContext="{d:DesignInstance manageSources:ManageSourcesViewModel, IsDesignTimeCreatable=True}"
             mc:Ignorable="d"
             d:DesignHeight="500" d:DesignWidth="900">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:DoubleToPercentageConverter x:Key="DoubleToPercentageConverter" />
        <Style x:Key="CenteredVerticallyColumn" TargetType="DataGridCell"
               BasedOn="{StaticResource {x:Type DataGridCell}}">
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>
        <Style x:Key="RefreshHeader" TargetType="DataGridColumnHeader"
               BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
            <Setter Property="HorizontalAlignment" Value="Center" />
        </Style>
    </UserControl.Resources>

    <Border Background="{DynamicResource ShadcnCardBrush}"
            BorderBrush="{DynamicResource ShadcnBorderBrush}"
            BorderThickness="1"
            CornerRadius="12"
            Padding="0"
            MinWidth="800"
            MaxWidth="1000"
            MaxHeight="600">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Header -->
            <Border Grid.Row="0"
                    Background="{DynamicResource ShadcnMutedBrush}"
                    CornerRadius="12,12,0,0"
                    Padding="20,16">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0"
                               Text="Manage Sources"
                               FontSize="18"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource ShadcnForegroundBrush}"
                               VerticalAlignment="Center" />

                    <Button Grid.Column="1"
                            Style="{StaticResource ShadcnIconButton}"
                            Command="{Binding CloseCommand}"
                            ToolTip="Close"
                            Width="32"
                            Height="32">
                        <materialDesign:PackIcon Kind="Close"
                                                 Width="18"
                                                 Height="18"
                                                 Foreground="{DynamicResource ShadcnMutedForegroundBrush}" />
                    </Button>
                </Grid>
            </Border>

            <!-- Content -->
            <ScrollViewer Grid.Row="1"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Auto"
                          Padding="8">
                <materialDesign:Card
                    Margin="5"
                    Padding="5,5,5,15"
                    materialDesign:ElevationAssist.Elevation="Dp6">
                    <StackPanel>
                        <TextBlock
                            Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                            Margin="0,10,0,10"
                            Text="Available Sources"
                            HorizontalAlignment="Center" />
                        <Button Content="Refresh All"
                                Width="120"
                                Margin="0,10,10,10"
                                HorizontalAlignment="Right"
                                Style="{StaticResource MaterialDesignFlatSecondaryMidBgButton}"
                                ToolTip="Refresh available trips data"
                                Command="{Binding DataContext.RefreshAllSourcesCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                        <DataGrid
                            AutoGenerateColumns="False"
                            CanUserAddRows="False"
                            CanUserDeleteRows="False"
                            CanUserReorderColumns="True"
                            CanUserResizeColumns="True"
                            CanUserResizeRows="True"
                            CanUserSortColumns="True"
                            IsReadOnly="True"
                            ItemsSource="{Binding Sources}"
                            SelectionMode="Single"
                            SelectionUnit="FullRow"
                            Style="{StaticResource MaterialDesignDataGrid}"
                            VerticalScrollBarVisibility="Auto">
                            <DataGrid.Columns>
                                <DataGridTextColumn CellStyle="{StaticResource CenteredVerticallyColumn}"
                                                    Header="Name"
                                                    Binding="{Binding Name}" />
                                <DataGridTextColumn CellStyle="{StaticResource CenteredVerticallyColumn}" Header="Updated"
                                                    Binding="{Binding ChangedAt, StringFormat=yyyy-MM-dd HH:mm:ss, TargetNullValue=N/A}" />
                                <DataGridTextColumn CellStyle="{StaticResource CenteredVerticallyColumn}" Header="Records Count"
                                                    Binding="{Binding TripsCount}" />
                                <DataGridTemplateColumn Header="Refresh?" HeaderStyle="{StaticResource RefreshHeader}">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Content="Refresh"
                                                    Style="{StaticResource MaterialDesignFlatSecondaryMidBgButton}"
                                                    ToolTip="Refresh available trips data"
                                                    Command="{Binding DataContext.RefreshSourceCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding SourceId}" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn Header="Status">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="*" />
                                                </Grid.RowDefinitions>
                                                <ProgressBar
                                                    Grid.Row="0"
                                                    Width="240"
                                                    Height="{Binding ElementName=ProgressBarTextBlock, Path=ActualHeight}"
                                                    MinHeight="25"
                                                    Background="{DynamicResource MaterialDesign.Brush.Secondary.Light}"
                                                    Foreground="{DynamicResource MaterialDesign.Brush.Secondary.Dark}"
                                                    Visibility="{Binding ShowProgress, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                    Value="{Binding ProgressPercent, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" />
                                                <TextBlock
                                                    x:Name="ProgressBarTextBlock"
                                                    Grid.Row="0"
                                                    Width="240"
                                                    MinHeight="20"
                                                    Padding="5"
                                                    TextAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    Foreground="{DynamicResource PrimaryHueDarkForegroundBrush}"
                                                    Text="{Binding ProgressPercent, Mode=OneWay, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource DoubleToPercentageConverter}}"
                                                    TextWrapping="WrapWithOverflow"
                                                    Visibility="{Binding ShowProgress, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                            </Grid>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </StackPanel>
                </materialDesign:Card>
            </ScrollViewer>
        </Grid>
    </Border>
</UserControl>
